<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de texte à trous</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <header class="navbar">
        <div class="navbar-left">
            <img src="rabbit.svg" alt="Lapin" class="icon-lapin" id="icon-lapin">
            <span>FB</span>
        </div>
        <div class="navbar-right">
            <a href="https://github.com/fabburst/ClozeTest">GitHub</a>
            <a href="help.html" id="help-toggle"><i class="fas fa-question-circle"></i></a>
            <button id="toggle-dark-mode"><i class="fas fa-sun" id="icon"></i></button>
        </div>
    </header>

    <div id="header">
        <h1>Générateur de texte à trous</h1>
        <p id="welcome-text">Bienvenue dans l'application de génération de textes à trous, collez votre texte dans le champ ci-dessous, choisissez un mode et générez un texte à trous. Plus d'aide en cliquant sur l'icône <a href="help.html"> ou ici</a>.</p>
        <a href="#" id="resume-link" style="display: none;">Retour à la sélection</a>
    </div>
    <div id="input-container">
        <textarea onclick="paste(this)" id="original-text" placeholder="Collez votre texte ici..."></textarea>
        <div class="controls">
            <button id="generate-cloze"><i class="fas fa-magic"></i> Générer</button>
            <select id="mode-select">
                <option value="hide">Cacher les mots</option>
                <option value="type">Taper les mots</option>
            </select>
        </div>
    </div>
    <div id="output-container">
        <div id="cloze-text"></div>
    </div>
    <button id="validate-words" style="display: none;"><i class="fas fa-check"></i> Valider les mots</button>
    <button id="toggle-original-text" style="display: none;"><i class="fas fa-eye"></i> Afficher le texte original</button>
    <div id="original-text-container" style="display: none;"></div>
    <button id="reset"><i class="fas fa-redo"></i> Réinitialiser</button>

    <script src="script.js"></script>

    <!-- Script pour la fonctionnalité de reprise du texte précédent -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const originalText = document.getElementById('original-text');
            const clozeText = document.getElementById('cloze-text');
            const validateWordsButton = document.getElementById('validate-words');
            const toggleOriginalTextButton = document.getElementById('toggle-original-text');
            const resumeLink = document.getElementById('resume-link');
            const generateButton = document.getElementById('generate-cloze');
            const resetButton = document.getElementById('reset');

            // Function to save the current state
            function saveState(userIP) {
                const state = {
                    originalText: originalText.value,
                    clozeText: clozeText.innerHTML,
                    showOriginalTextButton: toggleOriginalTextButton.style.display,
                    validateWordsButton: validateWordsButton.style.display,
                };
                localStorage.setItem(`clozeTextState_${userIP}`, JSON.stringify(state));
            }

            // Function to load the saved state
            function loadState(userIP) {
                const savedState = localStorage.getItem(`clozeTextState_${userIP}`);
                if (savedState) {
                    const state = JSON.parse(savedState);
                    originalText.value = state.originalText;
                    clozeText.innerHTML = state.clozeText;
                    toggleOriginalTextButton.style.display = state.showOriginalTextButton;
                    validateWordsButton.style.display = state.validateWordsButton;

                    // Reinitialize cloze text with event listeners
                    reinitializeClozeText();
                }
            }

            // Reinitialize cloze text with event listeners
            function reinitializeClozeText() {
                const spans = clozeText.querySelectorAll('span');
                spans.forEach(span => {
                    span.addEventListener('click', function() {
                        this.classList.toggle('selected-word');
                    });
                });
            }

            // Get user IP and store it
            fetch('https://api64.ipify.org?format=json')
                .then(response => response.json())
                .then(data => {
                    const userIP = data.ip;
                    localStorage.setItem('userIP', userIP);
                    
                    // Show the resume link if there is a saved state
                    if (localStorage.getItem(`clozeTextState_${userIP}`)) {
                        resumeLink.style.display = 'block';
                        resumeLink.href = `#${userIP}`;
                    }

                    // Load state if the URL contains the user IP
                    if (window.location.hash === `#${userIP}`) {
                        loadState(userIP);
                    }

                    // Save state on button clicks
                    generateButton.addEventListener('click', () => saveState(userIP));
                    resetButton.addEventListener('click', () => saveState(userIP));
                    validateWordsButton.addEventListener('click', () => saveState(userIP));
                    toggleOriginalTextButton.addEventListener('click', () => saveState(userIP));

                    // Load original text when clicking on resume link
                    resumeLink.addEventListener('click', (event) => {
                        event.preventDefault();
                        const savedState = localStorage.getItem(`clozeTextState_${userIP}`);
                        if (savedState) {
                            const state = JSON.parse(savedState);
                            originalText.value = state.originalText;
                            clozeText.innerHTML = '';
                            toggleOriginalTextButton.style.display = 'none';
                            validateWordsButton.style.display = 'none';

                            // Afficher le champ de texte avec le texte original
                            document.getElementById('input-container').style.display = 'block';
                            document.getElementById('output-container').style.display = 'none';
                        }
                    });
                });
        });
    </script>
    <script>
        async function paste(input) {
            try {
                const text = await navigator.clipboard.readText();
                input.value = text;
            } catch (err) {
                console.error('Failed to read clipboard contents: ', err);
            }
        }
    </script>
</body>
</html>
